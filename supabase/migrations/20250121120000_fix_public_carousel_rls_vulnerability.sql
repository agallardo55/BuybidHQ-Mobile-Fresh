-- ================================================================
-- CRITICAL SECURITY FIX: Overly Permissive RLS Policy on bid_requests
-- ================================================================
--
-- VULNERABILITY: RLS policy "Public carousel: all bids for anon" 
-- had qual="true" exposing ALL bid requests to anonymous users
--
-- IMPACT: 
-- - All bid requests visible to everyone (even unauthenticated)
-- - Cross-account data leakage
-- - Exposes VINs, pricing, user IDs, and business intelligence
--
-- FIX:
-- - Drop the dangerous policy
-- - Replace with properly scoped policy
-- - Only show approved bids from last 30 days
-- - Protect account privacy
--
-- DATE: 2025-01-21
-- SEVERITY: HIGH
-- ================================================================

-- Step 1: Drop the overly permissive policy
DROP POLICY IF EXISTS "Public carousel: all bids for anon" ON public.bid_requests;

-- Step 2: Create properly scoped policy for public carousel
CREATE POLICY "Public carousel: approved recent bid requests only"
ON public.bid_requests
FOR SELECT
TO anon
USING (
  status = 'Approved'::bid_status
  AND created_at >= NOW() - INTERVAL '30 days'
);

-- Step 3: Add comment for documentation
COMMENT ON POLICY "Public carousel: approved recent bid requests only" ON public.bid_requests IS 
'Security-hardened policy for public carousel. Only exposes approved bids from last 30 days. All other bid requests remain private to account owners.';

-- Step 4: Verify the fix
DO $$
DECLARE
  policy_count INTEGER;
  policy_qual TEXT;
BEGIN
  -- Check that the dangerous policy is gone
  SELECT COUNT(*) INTO policy_count
  FROM pg_policies
  WHERE tablename = 'bid_requests'
    AND policyname = 'Public carousel: all bids for anon';
  
  IF policy_count > 0 THEN
    RAISE EXCEPTION 'SECURITY FIX FAILED: Dangerous policy still exists!';
  END IF;

  -- Check that the new policy is correctly configured
  SELECT qual INTO policy_qual
  FROM pg_policies
  WHERE tablename = 'bid_requests'
    AND policyname = 'Public carousel: approved recent bid requests only';
  
  IF policy_qual IS NULL THEN
    RAISE EXCEPTION 'SECURITY FIX FAILED: New policy not found!';
  END IF;

  IF policy_qual = 'true' THEN
    RAISE EXCEPTION 'SECURITY FIX FAILED: New policy is still overly permissive!';
  END IF;

  RAISE NOTICE '✅ Security fix applied successfully';
  RAISE NOTICE '✅ Policy qualified with: %', policy_qual;
END $$;

-- Step 5: Audit log
INSERT INTO public.user_security_events (
  user_id,
  event_type,
  details,
  created_at
) VALUES (
  '00000000-0000-0000-0000-000000000000'::uuid, -- System user
  'rls_policy_security_fix',
  jsonb_build_object(
    'severity', 'HIGH',
    'vulnerability', 'overly_permissive_carousel_policy',
    'table', 'bid_requests',
    'old_policy', 'Public carousel: all bids for anon (qual=true)',
    'new_policy', 'Public carousel: approved recent bid requests only',
    'fix_date', NOW(),
    'description', 'Fixed RLS policy exposing all bid requests to anonymous users'
  ),
  NOW()
) ON CONFLICT DO NOTHING;

-- Step 6: Recommendations for follow-up
-- Run these queries to audit the extent of the exposure:
--
-- 1. Check how many bid requests were exposed:
--    SELECT status, COUNT(*) FROM bid_requests GROUP BY status;
--
-- 2. Check if any pending/declined bids are still visible:
--    SET ROLE anon;
--    SELECT COUNT(*) FROM bid_requests WHERE status != 'Approved';
--    RESET ROLE;
--
-- 3. Verify carousel only shows recent approved bids:
--    SET ROLE anon;
--    SELECT COUNT(*) FROM bid_requests;
--    -- Should only return approved bids from last 30 days
--    RESET ROLE;

